name: Deploy to 1Panel Server
on:
  push:
    branches: [ main, master ] # 监听的主分支
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Deploy to 1Panel server
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          # 设置部署目录（如果未配置DEPLOY_PATH则使用默认路径）
          if [ -n "${{ secrets.DEPLOY_PATH }}" ]; then
            DEPLOY_DIR="${{ secrets.DEPLOY_PATH }}"
          else
            DEPLOY_DIR="/soft/website"
          fi
          
          # 创建部署目录（如果不存在）
          echo "正在检查部署目录..."
          if [ ! -d "$DEPLOY_DIR" ]; then
            echo "创建部署目录: $DEPLOY_DIR"
            mkdir -p $DEPLOY_DIR
          fi
          
          # 进入项目部署目录
          cd $DEPLOY_DIR
          
          # 检查是否是首次部署（检查是否存在.git目录）
          if [ ! -d ".git" ]; then
            echo "首次部署，正在克隆仓库..."
            git clone ${{ secrets.GIT_REPO_URL }} .
            # 如果指定了分支，切换到对应分支
            if [ -n "${{ secrets.GIT_BRANCH }}" ]; then
              git checkout ${{ secrets.GIT_BRANCH }}
            else
              git checkout main || git checkout master
            fi
          else
            # 拉取最新代码
            echo "正在拉取最新代码..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          fi
          
          # 安装/更新依赖
          echo "正在安装依赖..."
          npm install --production=false
          
          # 清理旧的生成文件
          echo "正在清理旧文件..."
          npm run clean || hexo clean
          
          # 生成静态文件
          echo "正在生成静态文件..."
          npm run build
          
          # 将生成的静态文件复制到1Panel网站根目录
          echo "正在部署到Web目录..."
          if [ -n "${{ secrets.WEB_PATH }}" ]; then
            # 如果配置了WEB_PATH，复制到指定目录
            rsync -av --delete $DEPLOY_DIR/public/ ${{ secrets.WEB_PATH }}/
            echo "部署完成！文件已复制到 ${{ secrets.WEB_PATH }}"
          else
            echo "警告: 未配置 WEB_PATH，静态文件已生成在 $DEPLOY_DIR/public 目录"
          fi
          
          echo "部署成功！"